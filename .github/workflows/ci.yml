name: CI

on:
  push:
    branches: [ main, trunk ]
  pull_request:
    branches: [ main, trunk ]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Zsh
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh

      - name: Check for shell scripts
        id: check_scripts
        run: |
          if find . -type f \( -name "*.zsh" -o -name "*.sh" \) -print -quit | grep -q .; then
            echo "has_scripts=true" >> $GITHUB_OUTPUT
          else
            echo "has_scripts=false" >> $GITHUB_OUTPUT
          fi

      - name: Syntax check Zsh scripts
        if: steps.check_scripts.outputs.has_scripts == 'true'
        run: |
          echo "Checking Zsh scripts..."
          find . -type f -name "*.zsh" ! -path "*/templates/*" ! -name "*.template.*" -print0 | while IFS= read -r -d '' file; do
            echo "Checking: $file"
            zsh -n "$file" || exit 1
          done

      - name: Syntax check Bash scripts
        if: steps.check_scripts.outputs.has_scripts == 'true'
        run: |
          echo "Checking Bash scripts..."
          find . -type f -name "*.sh" ! -path "*/templates/*" ! -name "*.template.*" -print0 | while IFS= read -r -d '' file; do
            echo "Checking: $file"
            bash -n "$file" || exit 1
          done

      - name: Check for package.conf
        id: check_conf
        run: |
          if [ -f "package.conf" ]; then
            echo "has_conf=true" >> $GITHUB_OUTPUT
          else
            echo "has_conf=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate package.conf
        if: steps.check_conf.outputs.has_conf == 'true'
        run: |
          echo "Validating package.conf..."
          bash -n package.conf || exit 1

      - name: Check directory structure
        run: |
          echo "Package structure:"
          tree -L 3 -a || ls -la

      - name: Check for required files
        run: |
          echo "Checking for required files..."

          # Check for README
          if [ ! -f "README.md" ]; then
            echo "⚠️  Warning: README.md not found"
          else
            echo "✓ README.md found"
          fi

          # Check for LICENSE
          if [ ! -f "LICENSE" ]; then
            echo "⚠️  Warning: LICENSE not found"
          else
            echo "✓ LICENSE found"
          fi

          # Check for package.conf
          if [ ! -f "package.conf" ]; then
            echo "⚠️  Warning: package.conf not found"
          else
            echo "✓ package.conf found"
          fi

      - name: Validate symlink targets
        run: |
          echo "Checking for broken symlinks..."
          if find . -type l -exec test ! -e {} \; -print | grep -q .; then
            echo "❌ Broken symlinks found:"
            find . -type l -exec test ! -e {} \; -print
            exit 1
          else
            echo "✓ No broken symlinks"
          fi

      - name: Check for common issues
        run: |
          echo "Checking for common issues..."

          # Check for credentials
          if grep -r "password\|secret\|token\|api_key" --include="*.zsh" --include="*.sh" --exclude-dir=.git . 2>/dev/null | grep -v "# Example\|# TODO\|password=\$"; then
            echo "⚠️  Warning: Potential credentials found in code"
          fi

          # Check for absolute paths (potential portability issues)
          if grep -r "/home/\|/Users/" --include="*.zsh" --include="*.sh" --exclude-dir=.git . 2>/dev/null; then
            echo "⚠️  Warning: Hard-coded home paths found"
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Zsh
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh

      - name: Check for test directory
        id: check_tests
        run: |
          if [ -d "tests" ] || [ -d "test" ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        if: steps.check_tests.outputs.has_tests == 'true'
        run: |
          echo "Running tests..."

          # Look for test runner
          if [ -x "tests/run-tests.sh" ]; then
            ./tests/run-tests.sh
          elif [ -x "test/run-tests.sh" ]; then
            ./test/run-tests.sh
          elif [ -x "tools/test" ]; then
            ./tools/test
          elif [ -d "tests" ]; then
            # Run all test files
            for test_file in tests/*.zsh tests/*.sh test/*.zsh test/*.sh 2>/dev/null; do
              if [ -f "$test_file" ]; then
                echo "Running: $test_file"
                zsh "$test_file" || bash "$test_file"
              fi
            done
          else
            echo "No test runner found, skipping tests"
          fi

      - name: Report test results
        if: always()
        run: |
          echo "Test execution completed"

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: validate
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Check for shell scripts
        id: check_scripts
        run: |
          if find . -type f \( -name "*.zsh" -o -name "*.sh" \) -print -quit | grep -q .; then
            echo "has_scripts=true" >> $GITHUB_OUTPUT
          else
            echo "has_scripts=false" >> $GITHUB_OUTPUT
          fi

      - name: Run shellcheck
        if: steps.check_scripts.outputs.has_scripts == 'true'
        continue-on-error: true
        run: |
          echo "Running shellcheck..."
          find . -type f \( -name "*.sh" \) -exec shellcheck {} \; || echo "⚠️  Shellcheck found issues (non-blocking)"

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: validate
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh stow curl git

      - name: Install pkg-cli
        run: |
          echo "Installing pkg-cli..."
          mkdir -p ~/.pkg-cli/bin
          curl -fsSL https://raw.githubusercontent.com/andronics/pkg-cli/trunk/bin/pkg-cli -o ~/.pkg-cli/bin/pkg-cli
          chmod +x ~/.pkg-cli/bin/pkg-cli
          echo "$HOME/.pkg-cli/bin" >> $GITHUB_PATH

      - name: Verify pkg-cli installation
        run: |
          export PATH="$HOME/.pkg-cli/bin:$PATH"
          pkg-cli --version || echo "pkg-cli version check failed, continuing..."
          pkg-cli --help

      - name: Extract package name
        id: package_info
        run: |
          # Extract collection and name from repo
          REPO_NAME="${{ github.repository }}"
          REPO_NAME="${REPO_NAME#*/}"  # Remove owner/

          # Parse pkg-collection-name format
          if [[ "$REPO_NAME" =~ ^pkg-([^-]+)-(.+)$ ]]; then
            COLLECTION="${BASH_REMATCH[1]}"
            NAME="${BASH_REMATCH[2]}"
            PACKAGE="@${COLLECTION}/${NAME}"
            echo "package=$PACKAGE" >> $GITHUB_OUTPUT
            echo "collection=$COLLECTION" >> $GITHUB_OUTPUT
            echo "name=$NAME" >> $GITHUB_OUTPUT
            echo "Package: $PACKAGE"
          else
            echo "Failed to parse package name from: $REPO_NAME"
            exit 1
          fi

      - name: Test package installation
        env:
          PACKAGE: ${{ steps.package_info.outputs.package }}
        run: |
          export PATH="$HOME/.pkg-cli/bin:$PATH"

          echo "Testing installation of: $PACKAGE"

          # Clone the package
          pkg-cli -v clone "$PACKAGE" || {
            echo "❌ Failed to clone package"
            exit 1
          }

          echo "✅ Package cloned successfully"

      - name: Verify installation structure
        env:
          PACKAGE: ${{ steps.package_info.outputs.package }}
          COLLECTION: ${{ steps.package_info.outputs.collection }}
          NAME: ${{ steps.package_info.outputs.name }}
        run: |
          echo "Verifying installation structure..."

          REMOTE_DIR="$HOME/.local-packages/pkg-${COLLECTION}-${NAME}"

          # Check remote directory exists
          if [ ! -d "$REMOTE_DIR" ]; then
            echo "❌ Remote directory not found: $REMOTE_DIR"
            exit 1
          fi
          echo "✅ Remote directory exists: $REMOTE_DIR"

          # Check symlinks were created
          if [ -d "$REMOTE_DIR/.local" ]; then
            echo "Checking for symlinks in ~/.local..."

            # List what was stowed
            echo "Files in remote package:"
            find "$REMOTE_DIR/.local" -type f -o -type l | head -20

            # Verify at least some files were symlinked
            SYMLINK_COUNT=$(find ~/.local -type l -lname "$REMOTE_DIR/*" 2>/dev/null | wc -l)
            if [ "$SYMLINK_COUNT" -gt 0 ]; then
              echo "✅ Found $SYMLINK_COUNT symlinks from package"
            else
              echo "⚠️  Warning: No symlinks found, package may be empty or structure different"
            fi
          fi

      - name: Test package functionality
        env:
          COLLECTION: ${{ steps.package_info.outputs.collection }}
          NAME: ${{ steps.package_info.outputs.name }}
        run: |
          echo "Testing package functionality..."

          # Test based on collection type
          case "$COLLECTION" in
            core)
              # For core/lib, test that it can be loaded
              if [ "$NAME" = "lib" ]; then
                echo "Testing lib loading..."
                if [ -f "$HOME/.local/share/lib/core/lib-common.zsh" ]; then
                  zsh -c "source $HOME/.local/share/lib/core/lib-common.zsh && echo '✅ lib-common loaded successfully'" || {
                    echo "❌ Failed to load lib-common"
                    exit 1
                  }
                fi
              fi

              # For core/bin or core/kv, test binaries exist
              if [ -d "$HOME/.local/bin" ]; then
                BIN_COUNT=$(find ~/.local/bin -type f -o -type l 2>/dev/null | wc -l)
                if [ "$BIN_COUNT" -gt 0 ]; then
                  echo "✅ Found $BIN_COUNT binaries in ~/.local/bin"
                  find ~/.local/bin -type f -o -type l | head -5
                fi
              fi
              ;;

            system|devtools|apps|experimental)
              # Check for binaries
              if [ -d "$HOME/.local/bin" ]; then
                BIN_COUNT=$(find ~/.local/bin -type l -lname "*pkg-${COLLECTION}-${NAME}*" 2>/dev/null | wc -l)
                if [ "$BIN_COUNT" -gt 0 ]; then
                  echo "✅ Found $BIN_COUNT binaries from package"
                else
                  echo "ℹ️  No binaries found (package may not provide binaries)"
                fi
              fi
              ;;
          esac

          echo "✅ Functionality tests completed"

      - name: Test package update
        env:
          PACKAGE: ${{ steps.package_info.outputs.package }}
        run: |
          export PATH="$HOME/.pkg-cli/bin:$PATH"

          echo "Testing package update..."
          pkg-cli -v update "$PACKAGE" || {
            echo "❌ Failed to update package"
            exit 1
          }

          echo "✅ Package updated successfully"

      - name: Integration test summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ pkg-cli installation" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Package clone" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Stow symlinking" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Functionality verification" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Package update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Integration Test**: PASSED ✅" >> $GITHUB_STEP_SUMMARY

  package-info:
    name: Package Information
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract package info
        run: |
          echo "## Package Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Repository name
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for package.conf
          if [ -f "package.conf" ]; then
            echo "### package.conf" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            cat package.conf >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # File counts
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Zsh files: $(find . -name "*.zsh" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Shell files: $(find . -name "*.sh" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Total files: $(find . -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Total lines: $(find . -type f \( -name "*.zsh" -o -name "*.sh" \) -exec wc -l {} \; 2>/dev/null | awk '{sum+=$1} END {print sum}')" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [validate, test, lint, integration-test, package-info]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate.result }}" == "success" ]; then
            echo "✅ Validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test.result }}" == "success" ] || [ "${{ needs.test.result }}" == "skipped" ]; then
            echo "✅ Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint.result }}" == "success" ] || [ "${{ needs.lint.result }}" == "skipped" ]; then
            echo "✅ Lint: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️  Lint: WARNINGS" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.integration-test.result }}" == "success" ]; then
            echo "✅ Integration Test: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Integration Test: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Build ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
